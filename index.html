<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no, width=device-width, shrink-to-fit=no">
    <title>豹厂指引图</title>
    <style>
      html, body {
        margin: 0;
        width: 100%;
        height: 100%;
        overflow: hidden;
        background-color: #000;
      }
      #panolens-separate-container {
        position: absolute;
        width: 300px;
        height: 150px;
        right: 0;
        top: 100px;
      }
      #panolens-separate-container:-webkit-full-screen{
        left: 0;
        top: 0;
      }
      #panolens-separate-container:-moz-full-screen{
        left: 0;
        top: 0;
      }
      #panolens-separate-container:-ms-fullscreen{
        left: 0;
        top: 0;
      }
      #panolens-separate-container:fullscreen {
        left: 0;
        top: 0;
      }
      #progress {
        width: 0;
        height: 4px;
        position: fixed;
        top: 0;
        background: #00f;
        border-radius: 2px;
        -webkit-transition: opacity 0.5s ease;
        transition: opacity 0.5s ease;
      }
      #progress.finish {
        opacity: 0;
      }
      #arrow{position: fixed;top: 10px;width: 100%; display: none;}
      #error{position: fixed;bottom: 0;width: 100%;background: #000;height: 100px;color: #fff; overflow: auto;}
    </style>
  </head>
  <body>
    <script src="./three.min.js"></script>
  <script src="./panolens.js"></script>
  <!-- <script src="./panolens.min.js"></script> -->
  <div id="panolens-separate-container"></div>
  <div id="progress"></div>
  <script>
    // 判断是否是 ios 设备    
    function getIos() {
      let u = window.navigator.userAgent;
      return !! u.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/);
    }
    function requestPermissionsIOS() {
      requestDeviceMotionIOS();
      requestDeviceOrientationIOS();
    }
    function requestDeviceMotionIOS() {
      if (typeof(window.DeviceMotionEvent).requestPermission === 'function') { 
        (window.DeviceMotionEvent).requestPermission().then(permissionState =>{

          if (permissionState === 'granted') {
            window.addEventListener('devicemotion', () =>{

            });
          }
        }).
        catch((err) =>{
          alert(JSON.stringify(err)); alert("用户未允许权限");
        })
      } else {
        // handle regular non iOS 13+ devices
      }
    }

    // requesting device orientation permission
    function requestDeviceOrientationIOS() {
      if (typeof(DeviceOrientationEvent).requestPermission === 'function') { (
        DeviceOrientationEvent).requestPermission().then(permissionState =>{
          if (permissionState === 'granted') {
            window.addEventListener('deviceorientation', () =>{

            });
          }
        }).
        catch((err) =>{
          alert(JSON.stringify(err)); alert("用户未允许权限");
        })
      } else {
        // handle regular non iOS 13+ devices
      }
    }
    function testClick() {
        requestPermissionsIOS();
    }
  </script>
  <div id="arrow"><button onclick="testClick()">苹果兼容</button></div>
  <!-- <div id="error">123</div> -->
  <script>
    let viewer_main,three_1,three_2,three_3,three_4;
    let Widget;
    let spotChicago;
    progressElement = document.getElementById( 'progress' );
    let arrow = document.getElementById( 'arrow' );
    
    function onEnter ( event ) {
        progressElement.style.width = 0;
        progressElement.classList.remove( 'finish' );
      }
      function onProgress ( event ,spot) {
        progress = event.progress.loaded / event.progress.total * 100;
        progressElement.style.width = progress + '%';
        if ( progress === 100 ) {
          spot.focus( 1000, TWEEN.Easing['Exponential'][ 'out'] );
          progressElement.classList.add( 'finish' );
        }   
      }
    // Main panorama//{ initialLookAt: new THREE.Vector3( 2953.93, 1891.55, 5213.46 ) }
    viewer_main = new PANOLENS.Viewer({ enableReticle: false, output: 'overlay', viewIndicator: true, autoRotate: false, autoRotateSpeed: 2, autoRotateActivationDuration: 3000, dwellTime: 3000 });
    
    let logEvent = ( { type } ) => console.log( type );
    // panorama_main_video = new PANOLENS.VideoPanorama( 'asset/textures/video/ClashofClans.mp4', { autoplay: true, muted: false });
    //三楼楼梯口
    three_1 = new PANOLENS.ImagePanorama( 'asset/textures/three_1.jpeg' );
    three_1.addEventListener( 'progress', function(e){
      onProgress(e,spotXZ)
    });
    three_1.addEventListener( 'enter', onEnter );
    //行政部
    three_2 = new PANOLENS.ImagePanorama( 'asset/textures/three_2.jpeg' );
    three_2.addEventListener( 'progress', function(e){
      onProgress(e,spotNA)
    });
    three_2.addEventListener( 'enter', onEnter );
    three_3 = new PANOLENS.ImagePanorama( 'asset/textures/three_3.jpeg' );
    three_3.addEventListener( 'progress', function(e){
      onProgress(e,spotNA)
    });
    three_3.addEventListener( 'enter', onEnter );
    three_4 = new PANOLENS.ImagePanorama( 'asset/textures/three_4.jpeg' );
    three_4.addEventListener( 'progress', function(e){
      onProgress(e,spotNA)
    });
    three_4.addEventListener( 'enter', onEnter );
    // 图片切换图标
    // infospot1.addEventListener( 'click', function(){
    //   viewer_main.tweenControlCenterByObject( cube );
    // } );
    three_1.link( three_2, new THREE.Vector3(4317.34, -2337.87, 930.03 ),300,'','up');
    three_2.link( three_1, new THREE.Vector3(-2668.35, -620.15, 93.96 ),300,'','up');
    three_2.link( three_3, new THREE.Vector3(155.56, -832.46, 4920.29 ),300,'','up');
    three_3.link( three_4, new THREE.Vector3(-4876.94, -1036.19, 209.44),300,'','up');
    three_4.link( three_1, new THREE.Vector3(-7.03, -703.50, -4947.39),300,'','up');
    three_1.link( three_4, new THREE.Vector3(228.62, -995.62, 4884.00),300,'','up');
    //地点标示
    spotXZ = new PANOLENS.Infospot( 350, PANOLENS.DataImage.Info );
    spotXZ.position.set( 4934.51, -209.82, -710.54);
    spotXZ.addHoverText( '行政部' );
    
    spotChicago = new PANOLENS.Infospot( 350, PANOLENS.DataImage.Info );
    spotChicago.position.set(-1120.33, -554.15, -4833.36 );
    spotChicago.addHoverText( '芝加哥会议室' );
    three_1.add( spotChicago,spotXZ );

    spotNA = new PANOLENS.Infospot( 350, PANOLENS.DataImage.Info );
    spotNA.position.set( 139.76, -1317.78, 4812.07 );
    spotNA.addHoverText( '北美洲' );

    spotBBY = new PANOLENS.Infospot( 350, PANOLENS.DataImage.Info );
    spotBBY.position.set( 1598.36, -272.83, 4723.37);
    spotBBY.addHoverText( '北冰洋' );

    spotStair = new PANOLENS.Infospot( 350, PANOLENS.DataImage.Info );
    spotStair.position.set(-4956.35, -432.20, 448.92 );
    spotStair.addHoverText( '三楼楼梯口' );
    three_2.add( spotStair,spotNA,spotBBY );

    //添加场景图
    viewer_main.add( three_1, three_2,three_3,three_4 );
    //获取陀螺仪
    if(getIos()){
      arrow.style.display='block';
      viewer_main.enableControl( PANOLENS.CONTROLS.ORBIT );
    }else{
      viewer_main.enableControl( PANOLENS.CONTROLS.DEVICEORIENTATION );
    }
    // viewer_main.enableEffect( PANOLENS.MODES.CARDBOARD );
    // viewer_main.enableControl( PANOLENS.CONTROLS.ORBIT );
    // viewer_main.enableEffect( PANOLENS.MODES.NORMAL );

    //获取地理位置
    three_1.addEventListener('click',  function(e){
      let camera=viewer_main.getCamera();
      let scence=viewer_main.getScene();
      let vector = new THREE.Vector3();//三维坐标对象
      
      vector.set(
        ( (e.clientX||e.mouseEvent.clientX) / window.innerWidth ) * 2 - 1,
        - ( (e.clientY||e.mouseEvent.clientY) / window.innerHeight ) * 2 + 1,
        0.5 );
      vector.unproject( camera );
      
      let raycaster = new THREE.Raycaster(camera.position, vector.sub(camera.position).normalize());
      let intersects = raycaster.intersectObjects(scence.children);
      
      if (intersects.length > 0) {
        let selected = intersects[0];//取第一个物体
        // console.log('xy正负互换')
        // console.log("x坐标:"+selected.point.x);
        // console.log("y坐标:"+selected.point.y);
        // console.log("z坐标:"+selected.point.z);
      }
    });
  </script>
  </body>
</html>